<!DOCTYPE html>
<html>

<head>
    <!-- 声明文档使用的字符编码 -->
    <meta charset='utf-8'>
    <!-- 优先使用 IE 最新版本和 Chrome -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <!-- 页面描述 -->
    <meta name="description" content="不超过150个字符" />
    <!-- 页面关键词 -->
    <meta name="keywords" content="" />
    <!-- 网页作者 -->
    <meta name="author" content="name, email@gmail.com" />
    <!-- 搜索引擎抓取 -->
    <meta name="robots" content="index,follow" />
    <!-- 为移动设备添加 viewport -->
    <meta name="viewport" content="initial-scale=1, maximum-scale=3, minimum-scale=1, user-scalable=no">
    <!-- `width=device-width` 会导致 iPhone 5 添加到主屏后以 WebApp 全屏模式打开页面时出现黑边 http://bigc.at/ios-webapp-viewport-meta.orz -->
    <!-- iOS 设备 begin -->
    <meta name="apple-mobile-web-app-title" content="标题">
    <!-- 添加到主屏后的标题（iOS 6 新增） -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <!-- 是否启用 WebApp 全屏模式，删除苹果默认的工具栏和菜单栏 -->
    <meta name="apple-itunes-app" content="app-id=myAppStoreID, affiliate-data=myAffiliateData, app-argument=myURL">
    <!-- 添加智能 App 广告条 Smart App Banner（iOS 6+ Safari） -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <!-- 设置苹果工具栏颜色 -->
    <meta name="format-detection" content="telphone=no, email=no" />
    <!-- 忽略页面中的数字识别为电话，忽略email识别 -->
    <!-- 启用360浏览器的极速模式(webkit) -->
    <meta name="renderer" content="webkit">
    <!-- 避免IE使用兼容模式 -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- 不让百度转码 -->
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <!-- 针对手持设备优化，主要是针对一些老的不识别viewport的浏览器，比如黑莓 -->
    <meta name="HandheldFriendly" content="true">
    <!-- 微软的老式浏览器 -->
    <meta name="MobileOptimized" content="320">
    <!-- uc强制竖屏 -->
    <meta name="screen-orientation" content="portrait">
    <!-- QQ强制竖屏 -->
    <meta name="x5-orientation" content="portrait">
    <!-- UC强制全屏 -->
    <meta name="full-screen" content="yes">
    <!-- QQ强制全屏 -->
    <meta name="x5-fullscreen" content="true">
    <!-- UC应用模式 -->
    <meta name="browsermode" content="application">
    <!-- QQ应用模式 -->
    <meta name="x5-page-mode" content="app">
    <!-- windows phone 点击无高光 -->
    <meta name="msapplication-tap-highlight" content="no">
    <meta content="telephone=no" name="format-detection" />
    <meta content="email=no" name="format-detection" />
    <!--样式-->
    <link href="css/reset.css?20170216_1.5" type="text/css" rel="stylesheet">
     <link rel="stylesheet" type="text/css" href="css/layer.css">
    <link rel="stylesheet" type="text/css" href="css/css.css?20170216_1.5" />
    <title>四茂摄影工作室</title>
    <script src="js/lib/flexible.js?20170216_1.5"></script>
    <script src="js/lib/flexible_css.js?20170216_1.5"></script>
</head>

<body>
    <div class="bg"></div>
    <div id="wrapper" class="pb160">
        <div class="gd-address mg26">
            <a href="addressList.html?o=H1994052645838&type=order">
                <dl id="addressId">
                </dl>
            </a>
        </div>
        <div class="order-confirm mg26">
            <h3>新增订单</h3>
            <ul data-id="1" id="orderList">
            </ul>
            <div class="money"><em class="fl">运费</em><span class="fr">￥10.00</span></div>
            <div class="money">
                <em class="fl">门店</em>
                <select style="height:1.44rem;color: #7C6CB7;" class="fr" name="shop" id="shopId">
                </select>
            </div>
        </div>
        <div class="footer">
            <div class="foot-btn">
                <a href="javascript:void(0);" id="to-Pay">确定订单</a>
            </div>
        </div>
        <!--底部-end-->
    </div>
    <!--wrapper-end-->
    <script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.js"></script>
    <script src="js/lib/jquery-jtemplates.js?20170216_1.5"></script>
    <script src="js/layer.js?20170216_1.5"></script>
    <script src="js/util.js"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script src="js/js.js?20170216_1.5"></script>
    <script>
    var orderId = util.GetRequest()["o"];
    var totalprice = 0; //price
    //初始化页面
    var init = (function() {
        util.sendAjax({
                url: g_baseUrl + "paySign",
                data: {
                    "openID": util.getSessionKey('openID'),
                    "url": "http://www.sumaophoto.net/webChat/confirmOrder2.html"
                }
            })
            .done(function(data) {
                var res = data.result ? data.result : {};
                wx.config({
                    debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                    appId: res.appId, // 必填，公众号的唯一标识
                    timestamp: res.timeStamp, // 必填，生成签名的时间戳
                    nonceStr: res.nonceStr, // 必填，生成签名的随机串
                    signature: res.signature, // 必填，签名，见附录1
                    jsApiList: ['chooseWXPay'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
                });
            }).fail(function(data) {

            });
        //查询订单
        util.sendAjax({
            url: g_baseUrl + "queryOrder",
            data: {
                openID: util.getSessionKey('openID'),
                orderNo: orderId
            }
        }).done(function(data) {
            totalprice = getPrice(data.result[0].images);
            //绘制页面
            util.fetchTpl("orderList", './subtpl/comfirmItem.html', {
                "orderList": data.result[0].images
            })
            console.log(data)
        }).fail(function() {
            alert("订单生成失败！请重新操作");
            window.history.go(-1); //返回上一页
        });
        //查询默认收货地址
        util.sendAjax({
            url: g_baseUrl + "queryAddress",
            data: {
                openID: util.getSessionKey('openID'),
                queryFlag: "default"
            }
        }).done(function(data) {
            //console.log(data);
            if (data.result && data.result.length > 0) {
                //addressId
                util.fetchTpl("addressId", './subtpl/comfirmAddress.html', {
                    "address": data.result[0]
                });

            } else {
                util.fetchTpl("addressId", './subtpl/comfirmAddress.html', {
                    "address": {
                        "addressId": "",
                        "rUserName": "",
                        "rPhone": "",
                        "rAddress": "添加收货地址",
                    }
                });
            }
        }).fail(function() {
            util.fetchTpl("addressId", './subtpl/comfirmAddress.html', {
                "address": {
                    "addressId": "",
                    "rUserName": "",
                    "rPhone": "",
                    "rAddress": "添加收货地址",
                }
            });
        });
        //查询门店信息
        util.sendAjax({
            url: g_baseUrl + "queryShop",
            data: {
                openID: util.getSessionKey('openID')
            }
        }).done(function(data) {
            //console.log(data);
            if (data.result && data.result.length > 0) {
                util.fetchTpl("shopId", './subtpl/select.html', {
                    "shops": data.result
                });
            }
        }).fail(function() {

        });
    })();

    function getPrice(obj) {
        var res = 0;
        $.each(obj, function(k, v) {
            res = res + v.price * v.number * 100;
        })
        return res;
    }
    //确定订单
    var Flg = true;
    if (Flg) {
        $("#to-Pay").click(function() {
            //console.log('Pay cli');
            Flg = false;
            var addrId = "119";
            var orderId = util.GetRequest()['o'];
            var addressId = $("#addressId").find("dt").attr("data-id");
            var shopId = $("#shopId").val();
            var orderAmt = totalprice;
            if (!orderId) {
                alert("订单编号不能为空");
                return;
            }
            if (!addressId) {
                alert("收货地址不能为空");
                return;
            }
            if (!shopId) {
                alert("门店信息不能为空");
                return;
            }
            if (!orderAmt) {
                alert("订单金额不能为空");
                return;
            }
            // var size = [],
            //     num = [];
            // $(".payment-list dd").each(function(index, element) {
            //     size.push($(this).attr("data-value"));
            //     num.push($(this).find(".show-count").text());
            // });
            util.sendAjax({
                url: g_baseUrl + "confirmOrder",
                data: {
                    openID: util.getSessionKey('openID'),
                    addressId: addressId,
                    shopId: shopId,
                    orderNo: orderId,
                    freightAmt:util.getSessionKey("freightAmt"),
                    orderAmt: parseInt(totalprice) //总价，包括运费
                }
            }).done(function(data) {
                var res = data.result ? data.result : {};
                wx.ready(function() {
                    //alert("成功");
                    wx.chooseWXPay({
                        timestamp: res.timeStamp, // 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符
                        nonceStr: res.nonceStr, // 支付签名随机串，不长于 32 位
                        package: res.package_gjz, // 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=***）
                        signType: res.signType, // 签名方式，默认为'SHA1'，使用新版支付需传入'MD5'
                        paySign: res.paySign, // 支付签名
                        success: function(res) {
                            window.location.replace("./orderlist.html")
                        }
                    });
                });
                wx.error(function() {
                    alert("支付失败，请重试");
                });
            }).fail(function() {
                alert("请重试！");
            });
        });
    }
    </script>
</body>

</html>
